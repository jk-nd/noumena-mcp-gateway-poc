openapi: 3.0.1
info:
  title: Noumena Platform - Engine Streams API
  version: '0.1'
servers:
  - url: '{server}'
    variables:
      server:
        default: http://localhost:12000/
tags:
  - name: Sse
    description: |
      The Platform Streams API is the platform's stream read model. It allows clients to either directly request
      (those endpoints containing `current-` - these streams are closed when completed), or subscribe to protocol
      states, commands and notifications using [Server Sent Events](https://html.spec.whatwg.org/multipage/server-sent-events.html) (SSEs).

      For SSEs, each element contains the fields `event`, `id` and `data` as per the specification. The `id` value, if
      present, can be used to set the `Last-Event-ID` header value to make the stream resume at that point. The `event`
      represents the event type, and relates to the `data` field (containing the payload).

      | Type (`event`) | Description    | Payload (`data`)                | `id` present |
      | -------------- |:---------------|:--------------------------------|:-------------|
      | `command`      | Command        | `ApiCommandPackageData`         | yes          |
      | `state`        | Protocol state | `ApiProtocolStatePackageData`   | yes          |
      | `tick`         | Heartbeat      | `ApiHeartbeatPackageData`       | no           |
      | `prototype`    | Prototype      | `ApiPrototypePackageData`       | yes          |
      | `notify`       | Notification   | `ApiNotificationPackageData`    | yes          |

      The SSE's return only those items associated to protocols that the token party is allowed to see.
paths:
  /api/streams:
    get:
      tags:
        - Sse
      summary: All
      description: "Returns a single server sent event (SSE) feed consisting of protocol states, commands, prototypes,
        notifications, and a heartbeat.
        Only items related to protocols instances on which the token party is a participant are returned.
        Note: Commands that are unrelated to any protocol will NOT be returned."
      operationId: streams
      parameters:
        - $ref: '#/components/parameters/LastEventId'
      responses:
        # Why can't these four lines be compressed into a single object under #/components/schemas?
        200: { $ref: '#/components/responses/200' }
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
      x-codegen-request-body-name: lastEventId
  /api/streams/notifications:
    get:
      tags:
        - Sse
      summary: Notifications
      description: "Returns a server sent event (SSE) feed consisting of notifications and a heartbeat.
        Only notifications related to protocols instances on which the token party is a participant are returned."
      operationId: notifications
      parameters:
        - $ref: '#/components/parameters/LastEventId'
      responses:
        200: { $ref: '#/components/responses/200' }
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
      x-codegen-request-body-name: lastEventId
  /api/streams/prototypes:
    get:
      tags:
        - Sse
      summary: Prototypes
      description: "Returns a server sent event (SSE) feed consisting of prototypes and a heartbeat.
        Prototypes describe the structure of NPL objects."
      operationId: prototypes
      parameters:
        - $ref: '#/components/parameters/LastEventId'
      responses:
        200: { $ref: '#/components/responses/200' }
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
      x-codegen-request-body-name: lastEventId
  /api/streams/states:
    get:
      tags:
        - Sse
      summary: States
      description: "Returns a server sent event (SSE) feed consisting of protocol states and a heartbeat.
        These protocol states always constitute the latest available protocol state version. Whenever protocols change,
        newer states are pushed onto this stream. For any given protocol, later states therefore supersede earlier ones.
        Only protocol instances on which the token party is a participant are returned."
      operationId: states
      parameters:
        - $ref: '#/components/parameters/LastEventId'
      responses:
        200: { $ref: '#/components/responses/200' }
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
      x-codegen-request-body-name: lastEventId
  /api/streams/current-archived-states:
    get:
      tags:
        - Sse
      summary: Retrieve all currently available protocol states
      description: "Returns a finite feed consisting of all protocol states available in the engine data store.
        Only protocol instances on which the token party is a participant are returned.
        Note: This API only returns those historical protocol states available in the engine data store.
        Use the history states API for the complete audit trail of a protocol."
      operationId: getCurrentArchivedStates
      parameters:
        - $ref: '#/components/parameters/protocolId'
        - $ref: 'engine.yml#/components/parameters/commandId'
        - $ref: '#/components/parameters/userId'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/until'
      responses:
        200:
          description: OK
          content:
            text/event-stream:
              schema:
                type: array
                items:
                  $ref: 'engine.yml#/components/schemas/ApiHistoricalProtocolState'
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
  /api/streams/current-states:
    get:
      tags:
        - Sse
      summary: Retrieve all current states
      description: "Returns a feed consisting of the most recent version of all currently existing protocol states.
        Unlike the other streams this one does not contain a heartbeat, is finite (as there are fixed number of existing
        states) and does not wrap the individual elements in server-side-events.
        Only protocol instances on which the token party is a participant are returned."
      operationId: getCurrentProtocolStates
      parameters:
        - $ref: 'engine.yml#/components/parameters/prototypeId'
        - $ref: 'engine.yml#/components/parameters/protocolIds'
        - $ref: 'engine.yml#/components/parameters/notCurrentState'
        - $ref: 'engine.yml#/components/parameters/currentState'
        - $ref: 'engine.yml#/components/parameters/commandId'
        - $ref: 'engine.yml#/components/parameters/metadata'
      responses:
        200:
          description: OK
          content:
            text/event-stream:
              schema:
                type: array
                items:
                  $ref: 'engine.yml#/components/schemas/ApiProtocolState'
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
  /api/streams/commands:
    get:
      tags:
        - Sse
      summary: Commands
      description: "Returns a server sent event (SSE) feed consisting of commands and a heartbeat.
        Only items related to protocols instances on which the token party is a participant are returned.
        Note: Commands that are unrelated to any protocol will NOT be returned."
      operationId: commands
      parameters:
        - $ref: '#/components/parameters/LastEventId'
      responses:
        200: { $ref: '#/components/responses/200' }
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
      x-codegen-request-body-name: lastEventId
  /api/streams/current-commands:
    get:
      tags:
        - Sse
      summary: Retrieve all currently available commands
      description: "Returns a feed consisting of all commands available in the engine data store. This stream is finite
        (as there are a fixed number of existing commands).
        Only items related to protocols instances on which the token party is a participant are returned.
        Note: Commands that are unrelated to any protocol will NOT be returned.
        Note: This API only returns those commands related to historical protocol states available in the engine data store.
        Use the history states API for the complete audit trail of a protocol (includes commands)."
      operationId: getCurrentCommands
      parameters:
        - $ref: '#/components/parameters/userId'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/until'
      responses:
        200:
          description: OK
          content:
            text/event-stream:
              schema:
                type: array
                items:
                  $ref: 'engine.yml#/components/schemas/ApiCommand'
        401: { $ref: '#/components/responses/401' }
        403: { $ref: '#/components/responses/403' }
        404: { $ref: '#/components/responses/404' }
      deprecated: false
      security:
        - openid_connect: [ ]
components:
  schemas:
    # SSEs
    ApiPackageData:
      title: ApiPackageData
      type: object
      required:
        - payloadType
      properties:
        payloadType:
          type: string
          enum:
            - clear
            - command
            - debugger_paused
            - debugger_failure
            - debugger_success
            - message
            - notify
            - prototype
            - state
            - tick
      discriminator:
        propertyName: payloadType
        mapping:
          clear: '#/components/schemas/ApiClearPackageData'
          command: '#/components/schemas/ApiCommandPackageData'
          debugger_paused: '#/components/schemas/ApiDebuggerPaused'
          debugger_failure: '#/components/schemas/ApiDebuggerFailure'
          debugger_success: '#/components/schemas/ApiDebuggerSuccess'
          message: '#/components/schemas/ApiMessagePackageData'
          notify: '#/components/schemas/ApiNotificationPackageData'
          prototype: '#/components/schemas/ApiPrototypePackageData'
          state: '#/components/schemas/ApiProtocolStatePackageData'
          tick: '#/components/schemas/ApiHeartbeatPackageData'

    ApiProtocolStatePackageData:
      title: 'ApiProtocolStatePackageData'
      description: "Payload for events of type 'state'."
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            commandId:
              type: string
              format: uuid
            payload:
              $ref: 'engine.yml#/components/schemas/ApiProtocolState'
            id:
              type: integer
              format: int64
              description: "Identifier of this state. Used to start the stream at some specific point."
    ApiPrototypePackageData:
      title: 'ApiPrototypePackageData'
      description: "Data for events of type 'prototype'."
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            prototype:
              $ref: '#/components/schemas/ApiPrototype'
            id:
              type: integer
              format: int64
              description: "Identifier of this prototype. Used to start the stream at some specific point."
    ApiHeartbeatPackageData:
      title: 'ApiHeartbeatPackageData'
      description: "Data for events of type 'tick'."
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            tick:
              type: integer
              format: int64
    ApiNotificationPackageData:
      title: 'ApiNotificationPackageData'
      description: "Data for events of type 'notification'."
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            notification:
              $ref: '#/components/schemas/ApiNotification'
            id:
              type: integer
              format: int64
              description: "Identifier of this event. Used to start the stream at some specific point."
    ApiCommandPackageData:
      title: 'ApiCommandPackageData'
      description: "Data for events of type 'command'."
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            command:
              $ref: 'engine.yml#/components/schemas/ApiCommand'
            id:
              type: integer
              format: int64
              description: "Identifier of this event. Used to start the stream at some specific point."
    ApiMessagePackageData:
      title: 'ApiMessagePackageData'
      description: "Data for events of type 'message'"
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            message:
              type: string
    ApiClearPackageData:
      title: 'ApiClearPackageData'
      description: "Data for events of type 'clear'"
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'
        - type: object
          properties:
            boolean:
              type: boolean
    ApiDebuggerEventPackageData:
      title: 'ApiDebuggerEventPackageData'
      allOf:
        - $ref: '#/components/schemas/ApiPackageData'

    # Development engine specific
    ApiDebuggerPaused:
      title: ApiDebuggerPaused
      allOf:
        - $ref: '#/components/schemas/ApiDebuggerEventPackageData'
        - type: object
          required:
            - stackTrace
          properties:
            stackTrace:
              type: array
              items:
                $ref: '#/components/schemas/ApiLocation'
            dirtyStates:
              type: array
              items:
                $ref: 'engine.yml#/components/schemas/ApiProtocolState'
            dirtyCommands:
              type: array
              items:
                $ref: 'engine.yml#/components/schemas/ApiCommand'
            dirtyNotifications:
              type: array
              items:
                $ref: '#/components/schemas/ApiNotification'

    ApiDebuggerSuccess:
      title: 'ApiDebuggerSuccess'
      allOf:
        - $ref: '#/components/schemas/ApiDebuggerEventPackageData'
        - type: object
          required:
            - result
          properties:
            result:
              $ref: 'engine.yml#/components/schemas/ApiValue'

    ApiDebuggerFailure:
      title: 'ApiDebuggerFailure'
      allOf:
        - $ref: '#/components/schemas/ApiDebuggerEventPackageData'
        - type: object
          required:
            - description
            - detail
          properties:
            description:
              type: string
            detail:
              type: string

    ApiLocation:
      title: ApiLocation
      type: object
      required:
        - file
        - line
        - callable
      properties:
        file:
          type: string
        line:
          type: integer
        callable:
          type: string
        protocolId:
          type: string
          format: uuid
        elementType:
          type: string
          enum: [ Constructor, Action, Builtin, Function, None ]

    ApiNotification:
      title: ApiNotification
      type: object
      required:
        - type
        - refId
        - agents
        - created
      properties:
        type:
          type: string
          readOnly: true
          default: 'notify'
        refId:
          type: string
          format: uuid
        protocolVersion:
          type: integer
          format: int64
        agents:
          type: array
          items:
            $ref: 'engine.yml#/components/schemas/ApiAgent'
        created:
          type: string
          format: date-time
        name:
          type: string
        arguments:
          type: array
          items:
            $ref: 'engine.yml#/components/schemas/ApiValue'
        callback:
          type: string

    # Prototype hierarchy
    ApiPrototype:
      title: ApiPrototype
      type: object
      required:
        - name
        - prototypeType
      properties:
        name:
          type: string
        prototypeType:
          type: string
          enum:
            - constant
            - enum
            - identifier
            - protocol
            - struct
            - union
      discriminator:
        propertyName: prototypeType
        mapping:
          constant: '#/components/schemas/ApiConstPrototype'
          enum: '#/components/schemas/ApiEnumPrototype'
          identifier: '#/components/schemas/ApiIdentifierPrototype'
          protocol: '#/components/schemas/ApiProtocolPrototype'
          struct: '#/components/schemas/ApiStructPrototype'
          union: '#/components/schemas/ApiUnionPrototype'
    ApiConstPrototype:
      title: ApiConstPrototype
      allOf:
        - $ref: '#/components/schemas/ApiPrototype'
        - type: object
          properties:
            value:
              $ref: 'engine.yml#/components/schemas/ApiValue'
    ApiProtocolPrototype:
      title: ApiProtocolPrototype
      allOf:
        - $ref: '#/components/schemas/ApiPrototype'
        - type: object
          properties:
            parties:
              type: array
              items:
                $ref: '#/components/schemas/ApiNamedArgument'
            arguments:
              type: array
              items:
                $ref: '#/components/schemas/ApiNamedArgument'
            actions:
              type: array
              items:
                $ref: '#/components/schemas/ApiAction'
    ApiStructPrototype:
      title: ApiStructPrototype
      allOf:
        - $ref: '#/components/schemas/ApiPrototype'
        - type: object
          properties:
            arguments:
              type: array
              items:
                $ref: '#/components/schemas/ApiNamedArgument'
    ApiUnionPrototype:
      title: ApiUnionPrototype
      allOf:
        - $ref: '#/components/schemas/ApiPrototype'
        - type: object
          properties:
            types:
              type: array
              items:
                type: string
    ApiEnumPrototype:
      title: ApiEnumPrototype
      allOf:
        - $ref: '#/components/schemas/ApiPrototype'
        - type: object
          required:
            - variants
          properties:
            variants:
              type: array
              items:
                type: string
    ApiIdentifierPrototype:
      title: ApiIdentifierPrototype
      allOf:
        - $ref: '#/components/schemas/ApiPrototype'
        - type: object
    ApiNamedArgument:
      title: ApiNamedArgument
      type: object
      required:
        - name
        - typeId
      properties:
        name:
          type: string
        typeId:
          type: string
    ApiAction:
      title: ApiAction
      type: object
      required:
        - name
        - parties
        - arguments
        - returnType
      properties:
        name:
          type: string
        parties:
          type: array
          items:
            $ref: '#/components/schemas/ApiNamedArgument'
        arguments:
          type: array
          items:
            $ref: '#/components/schemas/ApiNamedArgument'
        returnType:
          type: string
  responses:
    200:
      description: OK
      content:
        text/event-stream:
          schema:
            type: array
            items:
              $ref: '#/components/schemas/ApiPackageData'
    401:
      description: Unauthorized
      content: { }
    403:
      description: Forbidden
      content: { }
    404:
      description: Not Found
      content: { }
  parameters:
    LastEventId:
      name: Last-Event-ID
      in: header
      description: Last seen event ID. Setting this causes the stream to not return any events prior to this event's ID.
      content:
        '*/*':
          schema:
            type: integer
            format: int64
      required: false
    protocolId:
      in: query
      name: protocolId
      schema:
        type: string
        format: uuid
      description: Filter for a specific protocol ID.
    userId:
      in: query
      name: userId
      schema:
        type: string
      description: Filter for elements created by a specific user ID.
    from:
      in: query
      name: from
      schema:
        type: string
        format: date-time
        description: ISO-8601 date time representation.
    until:
      in: query
      name: until
      schema:
        type: string
        format: date-time
        description: ISO-8601 date time representation.
  securitySchemes:
    openid_connect:
      type: http
      scheme: bearer
      bearerFormat: JWT
