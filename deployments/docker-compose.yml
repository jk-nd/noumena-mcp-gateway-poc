# Gateway Infrastructure - V2 Transparent Proxy Architecture
# Start with: docker compose up -d
#
# Network topology:
#   public-net:  Gateway, Keycloak (agent-facing)
#   policy-net:  Gateway, NPL Engine (policy checks)
#   backend-net: Gateway, upstream MCP containers (tool execution)
#
# For MCP servers, use: docker compose -f docker-compose.mcp.yml up -d

name: gateway

volumes:
  engine-db: { }
  keycloak-db: { }
  keycloak-provisioning: { }

services:
  # ─────────────────────────────────────────────────────────────────────────
  # NPL Engine (policy-net only — not directly accessible by agents)
  # ─────────────────────────────────────────────────────────────────────────
  npl-engine:
    image: ghcr.io/noumenadigital/images/engine:latest
    ports:
      - "12000:12000"
      - "12400:12400"
    volumes:
      - ../npl/src/main/yaml:/npl/yaml:ro
      - ../npl/src/main/npl-1.0:/npl/npl-1.0:ro
    environment:
      ENGINE_DEV_MODE: "false"
      # Keycloak issues tokens with iss=http://keycloak:11000/realms/mcpgateway
      # (KC_HOSTNAME=keycloak), which the engine can resolve on the Docker network
      ENGINE_ALLOWED_ISSUERS: "http://keycloak:11000/realms/mcpgateway"
      ENGINE_DB_URL: "jdbc:postgresql://engine-db:5432/engine"
      ENGINE_DB_USER: engine
      ENGINE_DB_PASSWORD: secret
      ENGINE_DB_HISTORY_USER: history
      ENGINE_DB_HISTORY_SCHEMA: history
      ENGINE_DB_READ_MODEL_USER: postgraphile
      ENGINE_NPL_MIGRATION_DIRECTORY_PATH: /npl
      ENGINE_CORS_ALLOWED_ORIGINS: "*"
    depends_on:
      engine-db:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - policy-net
      - public-net  # For Keycloak access

  engine-db:
    image: postgres:14.4-alpine
    mem_limit: 256m
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: engine
      ENGINE_DB_USER: engine
      ENGINE_DB_PASSWORD: secret
      HISTORY_DB_USER: history
      HISTORY_DB_PASSWORD: secret
      HISTORY_DB_SCHEMA: history
      READ_MODEL_DB_USER: postgraphile
      READ_MODEL_DB_PASSWORD: secret
    volumes:
      - engine-db:/var/lib/postgresql/data
      - ../db_init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: pg_isready -U postgres
      interval: 1s
      timeout: 5s
      retries: 50
    networks:
      - policy-net

  # ─────────────────────────────────────────────────────────────────────────
  # Keycloak + Provisioning (public-net — agent authentication)
  # ─────────────────────────────────────────────────────────────────────────
  keycloak:
    build:
      context: ../keycloak
    command: |
      start-dev
      --spi-events-listener-jboss-logging-success-level=info
      --spi-events-listener-jboss-logging-error-level=error
      --hostname-strict=false
      --health-enabled=true
      --http-enabled=true
      --db=postgres
      --http-port=11000
    ports:
      - "11000:11000"
      - "9000:9000"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: welcome
      KC_DB_URL: jdbc:postgresql://keycloak-db/postgres
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: testing
      KC_HEALTH_ENABLED: "true"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 11000
      KC_HOSTNAME_STRICT: "false"
      # Token issuer uses the Docker hostname so NPL Engine can fetch JWKS
      KC_HOSTNAME: keycloak
      KC_HOSTNAME_PORT: 11000
    depends_on:
      keycloak-db:
        condition: service_started
    healthcheck:
      test: curl http://localhost:9000/health || exit 1
      interval: 1s
      retries: 60
    networks:
      - public-net

  keycloak-db:
    image: postgres:14.4-alpine
    mem_limit: 256m
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: testing
    healthcheck:
      test: pg_isready -U postgres
      interval: 1s
      timeout: 5s
      retries: 50
    networks:
      - public-net

  keycloak-provisioning:
    build:
      context: ../keycloak-provisioning
    command: /local.sh
    volumes:
      - keycloak-provisioning:/state
      - ../configs:/configs  # Mount configs to sync user IDs to services.yaml
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: welcome
      KEYCLOAK_URL: http://keycloak:11000
      TF_VAR_default_password: Welcome123
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - public-net

  # ─────────────────────────────────────────────────────────────────────────
  # NPL Inspector (to view NPL state)
  # ─────────────────────────────────────────────────────────────────────────
  inspector:
    image: ghcr.io/noumenadigital/packages/inspector:latest
    ports:
      - "8080:8080"
    environment:
      - NPL_ENGINE_URL=http://localhost:12001
      - KEYCLOAK_URL=http://localhost:11000
      - KEYCLOAK_REALM=mcpgateway
      - KEYCLOAK_CLIENT_ID=mcpgateway
    depends_on:
      - npl-engine
      - keycloak-provisioning
    networks:
      - policy-net
      - public-net

  # ─────────────────────────────────────────────────────────────────────────
  # Vault (secrets-net only — credential storage)
  # ─────────────────────────────────────────────────────────────────────────
  vault:
    image: hashicorp/vault:latest
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "dev-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    networks:
      - secrets-net

  # ─────────────────────────────────────────────────────────────────────────
  # Credential Proxy (secrets-net — fetches from Vault, injects credentials)
  # ─────────────────────────────────────────────────────────────────────────
  credential-proxy:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.credential-proxy
    ports:
      - "9002:9002"
    environment:
      PORT: "9002"
      CREDENTIAL_MODE: "${CREDENTIAL_MODE:-simple}"
      CREDENTIAL_CONFIG_PATH: "/app/configs/credentials.yaml"
      NPL_URL: "http://npl-engine:12000"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "dev-token"
    volumes:
      - ../configs/credentials.yaml:/app/configs/credentials.yaml:ro
    networks:
      - secrets-net
      - policy-net
    depends_on:
      vault:
        condition: service_started
      npl-engine:
        condition: service_healthy

  # ─────────────────────────────────────────────────────────────────────────
  # Gateway Proxy (spans all networks)
  #
  # The Gateway is a transparent MCP proxy:
  #   - public-net: accepts agent connections, talks to Keycloak
  #   - policy-net: checks NPL policy before forwarding
  #   - secrets-net: requests credentials from Credential Proxy
  #   - backend-net: forwards approved calls to upstream MCPs
  # ─────────────────────────────────────────────────────────────────────────
  gateway:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.gateway
    ports:
      - "8000:8080"
    volumes:
      - ../configs/services.yaml:/app/configs/services.yaml:ro
      # Docker socket for STDIO transport — Gateway spawns upstream MCP containers
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - NPL_URL=http://npl-engine:12000
      - KEYCLOAK_URL=http://keycloak:11000
      - KEYCLOAK_REALM=mcpgateway
      - KEYCLOAK_CLIENT_ID=mcpgateway
      # Issuer must match what Keycloak puts in tokens (KC_HOSTNAME=keycloak)
      - KEYCLOAK_ISSUER=http://keycloak:11000/realms/mcpgateway
      # External URL for browser-facing OAuth redirects (authorization code flow)
      # Must use 'keycloak' hostname (resolved via /etc/hosts) to match KC_HOSTNAME
      # so login cookies stay on the same domain throughout the auth flow
      - KEYCLOAK_EXTERNAL_URL=http://keycloak:11000
      - GATEWAY_URL=http://gateway:8080
      - DEV_MODE=false
      # Dynamic services configuration
      - SERVICES_CONFIG_PATH=/app/configs/services.yaml
      # Credential Proxy
      - CREDENTIAL_PROXY_URL=http://credential-proxy:9002
    depends_on:
      npl-engine:
        condition: service_healthy
      credential-proxy:
        condition: service_started
    networks:
      - public-net
      - policy-net
      - secrets-net
      - backend-net

  # ─────────────────────────────────────────────────────────────────────────
  # Example Upstream MCP: DuckDuckGo (backend-net only)
  #
  # This is an example of an upstream MCP container that the Gateway
  # proxies to. It's only on backend-net — agents can't reach it directly.
  # ─────────────────────────────────────────────────────────────────────────
  # Uncomment to enable DuckDuckGo as an upstream MCP via HTTP:
  # duckduckgo-mcp:
  #   image: mcp/duckduckgo
  #   # Expose HTTP endpoint for Gateway to connect to
  #   # (not exposed to host - only accessible via backend-net)
  #   networks:
  #     - backend-net

  # ─────────────────────────────────────────────────────────────────────────
  # Integration Test Runner (on-demand)
  # ─────────────────────────────────────────────────────────────────────────
  test-runner:
    build:
      context: ..
      dockerfile: integration-tests/Dockerfile
    environment:
      - NPL_URL=http://npl-engine:12000
      - KEYCLOAK_URL=http://localhost:11000
      - GATEWAY_URL=http://gateway:8080
    depends_on:
      npl-engine:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      gateway:
        condition: service_started
    networks:
      - public-net
      - policy-net
    profiles:
      - test

# ─────────────────────────────────────────────────────────────────────────
# Network Isolation
#
# Four-tier network model:
#   public-net:  Agent-facing (Gateway, Keycloak)
#   policy-net:  Policy enforcement (Gateway ↔ NPL Engine)
#   secrets-net: Credential injection (Gateway ↔ Credential Proxy ↔ Vault)
#   backend-net: Upstream MCPs (Gateway ↔ MCP containers)
#
# Agents can only reach the Gateway and Keycloak.
# Upstream MCPs are isolated from agents, NPL, and secrets.
# Only Credential Proxy has Vault access.
# ─────────────────────────────────────────────────────────────────────────

  # CORS proxy for NPL Engine (needed for Inspector browser access)
  npl-cors-proxy:
    image: nginx:alpine
    ports:
      - "12001:12001"
    volumes:
      - ./nginx-cors.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - policy-net
      - public-net
    depends_on:
      - npl-engine

networks:
  public-net:
    driver: bridge
  policy-net:
    driver: bridge
  secrets-net:
    driver: bridge
  backend-net:
    driver: bridge
