# Gateway Infrastructure — Envoy AI Gateway + OPA + NPL Architecture
# Start with: docker compose up -d
#
# Architecture:
#   Envoy AI Gateway (port 8000) — MCP protocol, JWT auth, tool filtering, aggregation
#   OPA Sidecar (port 9191 gRPC / 8181 HTTP) — ext_authz policy evaluation via Rego
#   Bundle Server (port 8282) — subscribes to NPL SSE, serves OPA bundle
#   NPL Engine (port 12000) — Policy state manager (push via SSE to bundle server)
#   Supergateway sidecars — wrap STDIO MCP tools as Streamable HTTP
#
# Network topology:
#   public-net:  Envoy Gateway, Keycloak (agent-facing)
#   policy-net:  OPA, Bundle Server, NPL Engine (policy checks)
#   backend-net: Envoy Gateway, supergateway MCP containers (tool execution)
#   secrets-net: Credential Proxy, Vault (credential injection)

name: gateway

volumes:
  engine-db: { }
  keycloak-db: { }
  keycloak-provisioning: { }

services:
  # ─────────────────────────────────────────────────────────────────────────
  # NPL Engine (policy-net only — not directly accessible by agents)
  # ─────────────────────────────────────────────────────────────────────────
  npl-engine:
    image: ghcr.io/noumenadigital/images/engine:latest
    ports:
      - "12000:12000"
      - "12400:12400"
    volumes:
      - ../npl/src/main/yaml:/npl/yaml:ro
      - ../npl/src/main/npl-1.0:/npl/npl-1.0:ro
    environment:
      ENGINE_DEV_MODE: "false"
      # Accept tokens from both the Docker hostname and localhost issuer
      ENGINE_ALLOWED_ISSUERS: "http://keycloak:11000/realms/mcpgateway,http://localhost:11000/realms/mcpgateway"
      ENGINE_DB_URL: "jdbc:postgresql://engine-db:5432/engine"
      ENGINE_DB_USER: engine
      ENGINE_DB_PASSWORD: secret
      ENGINE_DB_HISTORY_USER: history
      ENGINE_DB_HISTORY_SCHEMA: history
      ENGINE_DB_READ_MODEL_USER: postgraphile
      ENGINE_NPL_MIGRATION_DIRECTORY_PATH: /npl
      ENGINE_CORS_ALLOWED_ORIGINS: "*"
    depends_on:
      engine-db:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - policy-net
      - public-net  # For Keycloak access

  engine-db:
    image: postgres:14.4-alpine
    mem_limit: 256m
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: engine
      ENGINE_DB_USER: engine
      ENGINE_DB_PASSWORD: secret
      HISTORY_DB_USER: history
      HISTORY_DB_PASSWORD: secret
      HISTORY_DB_SCHEMA: history
      READ_MODEL_DB_USER: postgraphile
      READ_MODEL_DB_PASSWORD: secret
    volumes:
      - engine-db:/var/lib/postgresql/data
      - ../db_init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: pg_isready -U postgres
      interval: 1s
      timeout: 5s
      retries: 50
    networks:
      - policy-net

  # ─────────────────────────────────────────────────────────────────────────
  # Keycloak + Provisioning (public-net — agent authentication)
  # ─────────────────────────────────────────────────────────────────────────
  keycloak:
    build:
      context: ../keycloak
    command: |
      start-dev
      --spi-events-listener-jboss-logging-success-level=info
      --spi-events-listener-jboss-logging-error-level=error
      --hostname-strict=false
      --health-enabled=true
      --http-enabled=true
      --db=postgres
      --http-port=11000
    ports:
      - "11000:11000"
      - "9000:9000"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: welcome
      KC_DB_URL: jdbc:postgresql://keycloak-db/postgres
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: testing
      KC_HEALTH_ENABLED: "true"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 11000
      KC_HOSTNAME_STRICT: "false"
      # Token issuer uses Docker hostname so engine + OPA can fetch JWKS.
      # Browser-based OAuth flows (MCP Inspector) require a hosts entry:
      #   127.0.0.1 keycloak
      KC_HOSTNAME: keycloak
      KC_HOSTNAME_PORT: 11000
    depends_on:
      keycloak-db:
        condition: service_started
    healthcheck:
      test: curl http://localhost:9000/health || exit 1
      interval: 1s
      retries: 60
    networks:
      - public-net

  keycloak-db:
    image: postgres:14.4-alpine
    mem_limit: 256m
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: testing
    healthcheck:
      test: pg_isready -U postgres
      interval: 1s
      timeout: 5s
      retries: 50
    networks:
      - public-net

  keycloak-provisioning:
    build:
      context: ../keycloak-provisioning
    command: /local.sh
    volumes:
      - keycloak-provisioning:/state
      - ../configs:/configs  # Mount configs to sync user IDs to services.yaml
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: welcome
      KEYCLOAK_URL: http://keycloak:11000
      TF_VAR_default_password: Welcome123
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - public-net

  # ─────────────────────────────────────────────────────────────────────────
  # NPL Inspector (to view NPL state)
  # ─────────────────────────────────────────────────────────────────────────
  inspector:
    image: ghcr.io/noumenadigital/packages/inspector:latest
    ports:
      - "8080:8080"
    environment:
      - NPL_ENGINE_URL=http://localhost:12001
      - KEYCLOAK_URL=http://localhost:11000
      - KEYCLOAK_REALM=mcpgateway
      - KEYCLOAK_CLIENT_ID=mcpgateway
    depends_on:
      - npl-engine
      - keycloak-provisioning
    networks:
      - policy-net
      - public-net

  # ─────────────────────────────────────────────────────────────────────────
  # Vault (secrets-net only — credential storage)
  # ─────────────────────────────────────────────────────────────────────────
  vault:
    image: hashicorp/vault:latest
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "dev-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    networks:
      - secrets-net

  # ─────────────────────────────────────────────────────────────────────────
  # Credential Proxy (secrets-net — fetches from Vault, injects credentials)
  # ─────────────────────────────────────────────────────────────────────────
  credential-proxy:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.credential-proxy
    ports:
      - "9002:9002"
    environment:
      PORT: "9002"
      CREDENTIAL_MODE: "${CREDENTIAL_MODE:-simple}"
      CREDENTIAL_CONFIG_PATH: "/app/configs/credentials.yaml"
      NPL_URL: "http://npl-engine:12000"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "dev-token"
    volumes:
      - ../configs/credentials.yaml:/app/configs/credentials.yaml:ro
    networks:
      - secrets-net
      - policy-net
    depends_on:
      vault:
        condition: service_started
      npl-engine:
        condition: service_healthy

  # ─────────────────────────────────────────────────────────────────────────
  # Governance Evaluator (policy-net — constraint evaluation sidecar)
  #
  # Sits between OPA and NPL ServiceGovernance. Evaluates argument-level
  # constraints (regex, contains, in/not_in, max_length) then routes to
  # NPL for approval workflows when needed.
  # ─────────────────────────────────────────────────────────────────────────
  governance-evaluator:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.governance-evaluator
    ports:
      - "8090:8090"
    environment:
      NPL_URL: "http://npl-engine:12000"
      KEYCLOAK_URL: "http://keycloak:11000"
      KEYCLOAK_REALM: "mcpgateway"
      GATEWAY_USERNAME: "gateway"
      GATEWAY_PASSWORD: "Welcome123"
      CACHE_REFRESH_SECONDS: "30"
      PORT: "8090"
    depends_on:
      npl-engine:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - policy-net
      - public-net  # For Keycloak token requests

  # ─────────────────────────────────────────────────────────────────────────
  # OPA Bundle Server (policy-net — serves NPL policy data as OPA bundle)
  #
  # Subscribes to NPL Engine SSE /api/streams/states for push notifications.
  # Rebuilds OPA bundle on every state change. OPA polls bundle every 1-2s.
  # Zero network I/O during policy evaluation — all data in OPA memory.
  # ─────────────────────────────────────────────────────────────────────────
  bundle-server:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.bundle-server
    ports:
      - "8282:8282"
    environment:
      NPL_URL: "http://npl-engine:12000"
      KEYCLOAK_URL: "http://keycloak:11000"
      KEYCLOAK_REALM: "mcpgateway"
      GATEWAY_USERNAME: "gateway"
      GATEWAY_PASSWORD: "Welcome123"
      PORT: "8282"
    depends_on:
      npl-engine:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - policy-net
      - public-net  # For Keycloak token requests

  # ─────────────────────────────────────────────────────────────────────────
  # OPA Sidecar (policy-net — ext_authz backend for Envoy)
  #
  # Evaluates Rego policy for every ext_authz request from Envoy.
  # Policy data loaded from OPA bundle (served by bundle-server).
  # Zero network I/O during evaluation — all data in memory.
  # ─────────────────────────────────────────────────────────────────────────
  opa:
    image: openpolicyagent/opa:latest-envoy
    platform: linux/amd64  # OPA Envoy image only ships amd64; runs via Rosetta on Apple Silicon
    ports:
      - "9191:9191"   # gRPC ext_authz (Envoy connects here)
      - "8181:8181"   # HTTP API (debugging, data inspection)
    environment:
      NPL_URL: "http://npl-engine:12000"
    volumes:
      - ../policies:/policies:ro
      - ./opa/opa-config.yaml:/config/opa-config.yaml:ro
    command:
      - "run"
      - "--server"
      - "--addr=:8181"
      - "--config-file=/config/opa-config.yaml"
      - "/policies"
    depends_on:
      bundle-server:
        condition: service_started
      npl-engine:
        condition: service_healthy
    networks:
      - policy-net

  # ─────────────────────────────────────────────────────────────────────────
  # Envoy AI Gateway (public-net — agent-facing MCP endpoint)
  #
  # Handles:
  #   - MCP protocol (Streamable HTTP)
  #   - JWT validation (Keycloak JWKS)
  #   - ext_authz to OPA sidecar (gRPC) for policy evaluation
  #   - Multi-server routing
  #   - SSE/streaming support
  # ─────────────────────────────────────────────────────────────────────────
  envoy-gateway:
    image: envoyproxy/envoy:v1.32-latest
    ports:
      - "8000:8000"   # MCP endpoint (agent-facing)
      - "9901:9901"   # Envoy admin interface
    volumes:
      - ./envoy/envoy-config.yaml:/etc/envoy/envoy.yaml:ro
      - ./envoy/mcp-servers.json:/etc/envoy/mcp-servers.json:ro
    command: ["envoy", "-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    depends_on:
      keycloak:
        condition: service_healthy
      opa:
        condition: service_started
      mcp-aggregator:
        condition: service_started
    networks:
      - public-net
      - backend-net
      - policy-net  # For ext_authz to OPA sidecar

  # ─────────────────────────────────────────────────────────────────────────
  # Backend MCP Services (supergateway sidecars)
  #
  # Each backend wraps a STDIO-based MCP tool as Streamable HTTP
  # using supergateway. Only accessible on backend-net.
  # ─────────────────────────────────────────────────────────────────────────

  # DuckDuckGo MCP — web search
  duckduckgo-mcp:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.supergateway
    environment:
      MCP_COMMAND: "docker run -i --rm mcp/duckduckgo"
      PORT: "8000"
    volumes:
      # Docker socket for spawning MCP containers
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - backend-net

  # GitHub MCP — GitHub API access (with credential injection)
  github-mcp:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.supergateway
    environment:
      MCP_COMMAND: "docker run -i --rm -e GITHUB_TOKEN mcp/github"
      PORT: "8000"
      # Credential injection at startup
      CREDENTIAL_PROXY_URL: "http://credential-proxy:9002"
      SERVICE_NAME: "github"
      TENANT_ID: "acme"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - backend-net
      - secrets-net  # For credential proxy access
    profiles:
      - github  # Only enable when GitHub credentials are configured

  # ─────────────────────────────────────────────────────────────────────────
  # MCP Aggregator (backend-net — multi-backend routing gateway)
  #
  # Sits between Envoy and backend MCP servers. Aggregates tools from all
  # backends and routes tool calls by namespace prefix.
  # ─────────────────────────────────────────────────────────────────────────
  mcp-aggregator:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.mcp-aggregator
    environment:
      PORT: "8000"
      BACKENDS: "duckduckgo:http://duckduckgo-mcp:8000,mock-calendar:http://mock-calendar-mcp:8000"
    depends_on:
      - duckduckgo-mcp
      - mock-calendar-mcp
    networks:
      - backend-net

  # Mock Calendar MCP — HTTP-native Streamable HTTP (bilateral streaming)
  mock-calendar-mcp:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.mock-calendar
    environment:
      PORT: "8000"
    networks:
      - backend-net

  # ─────────────────────────────────────────────────────────────────────────
  # Integration Test Runner (on-demand)
  # ─────────────────────────────────────────────────────────────────────────
  test-runner:
    build:
      context: ..
      dockerfile: integration-tests/Dockerfile
    environment:
      - NPL_URL=http://npl-engine:12000
      - KEYCLOAK_URL=http://localhost:11000
      - GATEWAY_URL=http://envoy-gateway:8000
    depends_on:
      npl-engine:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      envoy-gateway:
        condition: service_started
    networks:
      - public-net
      - policy-net
    profiles:
      - test

  # ─────────────────────────────────────────────────────────────────────────
  # Governance Dashboard (admin UI for v4 GatewayStore + ServiceGovernance)
  # ─────────────────────────────────────────────────────────────────────────
  dashboard:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.dashboard
    ports:
      - "8888:8888"
    environment:
      NPL_URL: "http://npl-engine:12000"
      KEYCLOAK_URL: "http://keycloak:11000"
      KEYCLOAK_REALM: "mcpgateway"
      ADMIN_USERNAME: "admin"
      ADMIN_PASSWORD: "Welcome123"
      GATEWAY_URL: "http://envoy-gateway:8000"
      OPA_URL: "http://opa:8181"
      BUNDLE_SERVER_URL: "http://bundle-server:8282"
      AGGREGATOR_URL: "http://mcp-aggregator:8000"
      DOCKER_NETWORK: "gateway_backend-net"
      PORT: "8888"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      npl-engine:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - policy-net
      - public-net
      - backend-net

  # CORS proxy for NPL Engine (needed for Inspector browser access)
  npl-cors-proxy:
    image: nginx:alpine
    ports:
      - "12001:12001"
    volumes:
      - ./nginx-cors.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - policy-net
      - public-net
    depends_on:
      - npl-engine

networks:
  public-net:
    driver: bridge
  policy-net:
    driver: bridge
  secrets-net:
    driver: bridge
  backend-net:
    driver: bridge
