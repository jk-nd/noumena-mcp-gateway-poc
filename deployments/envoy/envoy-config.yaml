# Envoy AI Gateway Configuration
#
# This is the static Envoy config for the MCP Gateway.
# It configures:
#   1. MCP protocol handling (Streamable HTTP on /mcp)
#   2. JWT validation via Keycloak JWKS
#   3. ext_authz to NPL Governance Service for stateful policy checks
#   4. Routing to backend MCP services (supergateway sidecars)

static_resources:
  listeners:
    - name: mcp_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8000
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: mcp_gateway
                codec_type: AUTO
                route_config:
                  name: mcp_routes
                  virtual_hosts:
                    - name: mcp_service
                      domains: ["*"]
                      routes:
                        # Health check endpoint (no auth required)
                        - match:
                            path: "/health"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"status":"healthy","service":"envoy-mcp-gateway"}'
                          response_headers_to_add:
                            - header:
                                key: "content-type"
                                value: "application/json"
                        # MCP endpoint — routed to DuckDuckGo backend (primary backend)
                        # In production, Envoy AI Gateway's MCPRoute handles multi-server
                        # aggregation. In this static config, we route to a single backend.
                        - match:
                            prefix: "/mcp"
                          route:
                            cluster: duckduckgo_mcp
                            timeout: 300s
                        # SSE endpoint for MCP Inspector compatibility
                        - match:
                            prefix: "/sse"
                          route:
                            cluster: duckduckgo_mcp
                            timeout: 0s  # No timeout for SSE streams
                        # Message endpoint for SSE transport
                        - match:
                            prefix: "/message"
                          route:
                            cluster: duckduckgo_mcp
                            timeout: 300s
                http_filters:
                  # Step 1: JWT Authentication (Keycloak)
                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        keycloak:
                          issuer: "http://keycloak:11000/realms/mcpgateway"
                          audiences:
                            - "account"
                            - "mcpgateway"
                          remote_jwks:
                            http_uri:
                              uri: "http://keycloak:11000/realms/mcpgateway/protocol/openid-connect/certs"
                              cluster: keycloak
                              timeout: 5s
                            cache_duration:
                              seconds: 300
                          forward: true
                          payload_in_metadata: "jwt_payload"
                      rules:
                        - match:
                            prefix: "/mcp"
                          requires:
                            provider_name: "keycloak"
                        - match:
                            prefix: "/sse"
                          requires:
                            provider_name: "keycloak"
                        - match:
                            prefix: "/message"
                          requires:
                            provider_name: "keycloak"
                        # Health endpoint — no JWT required
                        - match:
                            path: "/health"
                          requires:
                            allow_missing_or_failed: {}

                  # Step 2: External Authorization (NPL Governance Service)
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      http_service:
                        server_uri:
                          uri: "governance-service:8090"
                          cluster: governance_service
                          timeout: 5s
                        path_prefix: "/auth/check"
                        authorization_request:
                          headers_to_add:
                            - key: "x-forwarded-method"
                              value: "%REQ(:METHOD)%"
                        authorization_response:
                          allowed_upstream_headers:
                            patterns:
                              - prefix: "x-governance-"
                      failure_mode_allow: false  # Fail-closed: deny if governance unavailable

                  # Step 3: Router
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # Keycloak cluster (for JWKS fetching)
    - name: keycloak
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: keycloak
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: keycloak
                      port_value: 11000

    # NPL Governance Service (ext_authz backend)
    - name: governance_service
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: governance_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: governance-service
                      port_value: 8090

    # Backend MCP servers (supergateway wrapping STDIO tools)
    - name: duckduckgo_mcp
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: duckduckgo_mcp
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: duckduckgo-mcp
                      port_value: 8000

    - name: github_mcp
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: github_mcp
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: github-mcp
                      port_value: 8000

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
