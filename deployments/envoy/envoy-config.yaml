# Envoy AI Gateway Configuration
#
# This is the static Envoy config for the MCP Gateway.
# It configures:
#   1. MCP protocol handling (Streamable HTTP on /mcp)
#   2. JWT validation via Keycloak JWKS
#   3. ext_authz to OPA sidecar (gRPC) for policy evaluation
#   4. Routing to backend MCP services (supergateway sidecars)
#   5. OAuth discovery & proxy endpoints for MCP Inspector compatibility

static_resources:
  listeners:
    - name: mcp_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8000
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: mcp_gateway
                codec_type: AUTO
                route_config:
                  name: mcp_routes
                  virtual_hosts:
                    - name: mcp_service
                      domains: ["*"]
                      cors:
                        allow_origin_string_match:
                          - safe_regex:
                              regex: ".*"
                        allow_methods: "GET, POST, PUT, DELETE, OPTIONS"
                        allow_headers: "authorization, content-type, accept, mcp-session-id, mcp-protocol-version, last-event-id"
                        expose_headers: "mcp-session-id"
                        max_age: "86400"
                        allow_credentials: true
                      routes:
                        # Health check endpoint (no auth, no ext_authz)
                        - match:
                            path: "/health"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"status":"healthy","service":"envoy-mcp-gateway"}'
                          response_headers_to_add:
                            - header:
                                key: "content-type"
                                value: "application/json"
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # ── OAuth Discovery & Proxy (MCP Inspector compatibility) ──
                        # RFC 9728: OAuth Protected Resource Metadata
                        # SDK tries path-aware: /.well-known/oauth-protected-resource/mcp first
                        - match:
                            prefix: "/.well-known/oauth-protected-resource"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"resource":"http://localhost:8000","authorization_servers":["http://localhost:8000"],"bearer_methods_supported":["header"]}'
                          response_headers_to_add:
                            - header:
                                key: "content-type"
                                value: "application/json"
                            - header:
                                key: "access-control-allow-origin"
                                value: "*"
                            - header:
                                key: "access-control-allow-methods"
                                value: "GET, POST, OPTIONS"
                            - header:
                                key: "access-control-allow-headers"
                                value: "content-type, mcp-protocol-version, authorization"
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # RFC 8414: OAuth Authorization Server Metadata
                        # SDK tries path-aware: /.well-known/oauth-authorization-server/mcp first
                        - match:
                            prefix: "/.well-known/oauth-authorization-server"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"issuer":"http://localhost:8000","authorization_endpoint":"http://localhost:8000/authorize","token_endpoint":"http://localhost:8000/token","registration_endpoint":"http://localhost:8000/register","response_types_supported":["code"],"grant_types_supported":["authorization_code","refresh_token"],"code_challenge_methods_supported":["S256"],"token_endpoint_auth_methods_supported":["none"]}'
                          response_headers_to_add:
                            - header:
                                key: "content-type"
                                value: "application/json"
                            - header:
                                key: "access-control-allow-origin"
                                value: "*"
                            - header:
                                key: "access-control-allow-methods"
                                value: "GET, POST, OPTIONS"
                            - header:
                                key: "access-control-allow-headers"
                                value: "content-type, mcp-protocol-version, authorization"
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # RFC 7591: Dynamic Client Registration
                        # Returns pre-configured mcpgateway client info
                        - match:
                            path: "/register"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"client_id":"mcpgateway","client_name":"MCP Gateway","redirect_uris":["http://localhost:6274/oauth/callback","http://localhost:5173/oauth/callback","http://127.0.0.1:5173/oauth/callback","http://localhost:3000/oauth/callback"],"grant_types":["authorization_code","refresh_token"],"response_types":["code"],"token_endpoint_auth_method":"none"}'
                          response_headers_to_add:
                            - header:
                                key: "content-type"
                                value: "application/json"
                            - header:
                                key: "access-control-allow-origin"
                                value: "*"
                            - header:
                                key: "access-control-allow-methods"
                                value: "GET, POST, OPTIONS"
                            - header:
                                key: "access-control-allow-headers"
                                value: "content-type, mcp-protocol-version, authorization"
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # OAuth Authorization endpoint — redirect to Keycloak
                        # Preserves query params (client_id, redirect_uri, etc.)
                        # Must be 302 (not 301) — browsers cache 301 and break Keycloak sessions
                        - match:
                            path: "/authorize"
                          redirect:
                            host_redirect: "localhost:11000"
                            path_redirect: "/realms/mcpgateway/protocol/openid-connect/auth"
                            response_code: "FOUND"
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # OAuth Token endpoint — proxy to Keycloak
                        - match:
                            path: "/token"
                          route:
                            cluster: keycloak
                            prefix_rewrite: "/realms/mcpgateway/protocol/openid-connect/token"
                            host_rewrite_literal: "keycloak:11000"
                            timeout: 10s
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # CORS preflight for /mcp (OPTIONS — no auth needed)
                        # Must be before GET/POST so OPTIONS matches first and the
                        # CORS filter can add headers. Without this route, OPTIONS has
                        # no route match, bypasses the CORS filter, and gets rejected
                        # by the JWT filter with 401.
                        - match:
                            prefix: "/mcp"
                            headers:
                              - name: ":method"
                                string_match: {exact: "OPTIONS"}
                          direct_response:
                            status: 200
                            body:
                              inline_string: ""
                          typed_per_filter_config:
                            envoy.filters.http.ext_authz:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthzPerRoute
                              disabled: true

                        # MCP session termination (DELETE /mcp) — Streamable HTTP spec
                        - match:
                            prefix: "/mcp"
                            headers:
                              - name: ":method"
                                string_match: {exact: "DELETE"}
                          route:
                            cluster: mcp_aggregator
                            timeout: 5s

                        # MCP notification stream (GET /mcp) — long-lived SSE connection
                        # JWT required (authN) + ext_authz verifies service access (authZ)
                        # Governance checks once at stream setup, then notifications flow freely
                        - match:
                            prefix: "/mcp"
                            headers:
                              - name: ":method"
                                string_match: {exact: "GET"}
                          route:
                            cluster: mcp_aggregator
                            timeout: 0s  # Long-lived notification stream, never timeout

                        # MCP requests (POST /mcp) — JSON-RPC tool calls
                        # JWT required + ext_authz governance checks on every request
                        - match:
                            prefix: "/mcp"
                            headers:
                              - name: ":method"
                                string_match: {exact: "POST"}
                          route:
                            cluster: mcp_aggregator
                            timeout: 300s
                http_filters:
                  # Step 0: CORS (allow MCP Inspector browser at localhost:6274)
                  - name: envoy.filters.http.cors
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors

                  # Step 1: JWT Authentication (Keycloak)
                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        keycloak:
                          issuer: "http://localhost:11000/realms/mcpgateway"
                          audiences:
                            - "account"
                            - "mcpgateway"
                          remote_jwks:
                            http_uri:
                              uri: "http://keycloak:11000/realms/mcpgateway/protocol/openid-connect/certs"
                              cluster: keycloak
                              timeout: 5s
                            cache_duration:
                              seconds: 300
                          forward: true
                          payload_in_metadata: "jwt_payload"
                      rules:
                        # CORS preflight — no JWT required
                        - match:
                            prefix: "/mcp"
                            headers:
                              - name: ":method"
                                string_match: {exact: "OPTIONS"}
                          requires:
                            allow_missing_or_failed: {}
                        - match:
                            prefix: "/mcp"
                          requires:
                            provider_name: "keycloak"
                        - match:
                            prefix: "/sse"
                          requires:
                            provider_name: "keycloak"
                        - match:
                            prefix: "/message"
                          requires:
                            provider_name: "keycloak"
                        # Health + OAuth endpoints — no JWT required
                        - match:
                            path: "/health"
                          requires:
                            allow_missing_or_failed: {}
                        - match:
                            prefix: "/.well-known/oauth-protected-resource"
                          requires:
                            allow_missing_or_failed: {}
                        - match:
                            prefix: "/.well-known/oauth-authorization-server"
                          requires:
                            allow_missing_or_failed: {}
                        - match:
                            path: "/register"
                          requires:
                            allow_missing_or_failed: {}
                        - match:
                            path: "/authorize"
                          requires:
                            allow_missing_or_failed: {}
                        - match:
                            path: "/token"
                          requires:
                            allow_missing_or_failed: {}

                  # Step 1.5: Add WWW-Authenticate header on 401 (triggers MCP OAuth flow)
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function envoy_on_response(response_handle)
                          if response_handle:headers():get(":status") == "401" then
                            response_handle:headers():add("WWW-Authenticate", 'Bearer resource_metadata="http://localhost:8000/.well-known/oauth-protected-resource"')
                          end
                        end

                  # Step 2: External Authorization (OPA sidecar via gRPC)
                  # OPA evaluates Rego policy using NPL data cached via http.send()
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      grpc_service:
                        envoy_grpc:
                          cluster_name: opa_service
                        timeout: 1s  # allows for NPL fetch on cache miss
                      transport_api_version: V3
                      with_request_body:
                        max_request_bytes: 65536  # 64KB — enough for any JSON-RPC request
                        allow_partial_message: true
                        pack_as_bytes: false
                      failure_mode_allow: false  # Fail-closed: deny if OPA unavailable

                  # Step 3: Router
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # Keycloak cluster (for JWKS fetching)
    - name: keycloak
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: keycloak
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: keycloak
                      port_value: 11000

    # OPA sidecar (ext_authz backend via gRPC)
    - name: opa_service
      connect_timeout: 1s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {}
      load_assignment:
        cluster_name: opa_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: opa
                      port_value: 9191

    # MCP Aggregator (multi-backend routing gateway)
    - name: mcp_aggregator
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: mcp_aggregator
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: mcp-aggregator
                      port_value: 8000

    # Backend MCP servers (supergateway wrapping STDIO tools)
    - name: duckduckgo_mcp
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: duckduckgo_mcp
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: duckduckgo-mcp
                      port_value: 8000

    # Mock Calendar MCP (HTTP-native, bilateral streaming)
    - name: mock_calendar_mcp
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: mock_calendar_mcp
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: mock-calendar-mcp
                      port_value: 8000

    - name: github_mcp
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: github_mcp
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: github-mcp
                      port_value: 8000

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
